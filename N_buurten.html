<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <title>Den Helder Buurten</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.32/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.32/"></script>
    <style>
      /* Ensure the main container fills the viewport */
      html,
      body {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        font-family: Arial, sans-serif;
        overflow: hidden;
      }

      /* Main flex container for sidebar and map */
      #main-container {
        display: flex;
        height: 100vh;
        flex-direction: column;
      }
      
      /* Custom Sidebar Styling */
      #sidebar {
        width: 100%;
        background: white;
        padding: 15px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
        z-index: 10;
        overflow-y: auto;
        transition: height 0.3s ease-in-out, padding 0.3s ease-in-out;
        flex-shrink: 0;
        max-height: 70vh;
        border-radius: 12px 12px 0 0;
      }

      /* Styling for the collapse toggle button */
      #collapseToggle {
        width: 100%;
        margin-bottom: 15px;
        padding: 12px;
        background: #0079c1;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        display: block;
        text-align: center;
        transition: background-color 0.2s ease-in-out;
        font-size: 16px;
      }
      
      #collapseToggle:hover {
        background: #006ba1;
      }

      /* General styling for content panels */
      #sidebar > div {
        margin-bottom: 20px;
        transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, margin-bottom 0.3s ease-in-out;
        overflow: hidden;
        max-height: 500px;
        opacity: 1;
        padding-bottom: 0;
      }

      #sidebar > div:last-child {
        margin-bottom: 0;
      }

      #sidebar h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        font-size: 18px;
      }

      /* Button styling */
      .action-button {
        width: 100%;
        margin-bottom: 12px;
        padding: 12px;
        background: #0079c1;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out, opacity 0.2s ease-in-out;
        font-size: 16px;
      }
      
      .action-button:hover {
        background: #006ba1;
      }
      
      .action-button.active {
        background: #ff6a00;
      }
      
      /* Color picker styling */
      .color-picker-group {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .color-picker-group label {
        flex-grow: 1;
        margin-right: 10px;
        font-size: 16px;
      }

      .color-picker-group input[type="color"] {
        width: 50px;
        height: 35px;
        border: none;
        padding: 0;
        cursor: pointer;
        border-radius: 6px;
      }

      /* Category management */
      .category-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        padding: 8px;
        background: #f5f5f5;
        border-radius: 6px;
      }
      
      .category-color {
        width: 30px;
        height: 30px;
        border-radius: 4px;
        margin-right: 10px;
        border: 2px solid #ddd;
        cursor: pointer;
      }
      
      .category-name {
        flex: 1;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      
      .remove-category {
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 5px 10px;
        margin-left: 10px;
        cursor: pointer;
      }
      
      .remove-category:hover {
        background: #cc0000;
      }
      
      .add-category-btn {
        width: 100%;
        padding: 10px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
      }
      
      .add-category-btn:hover {
        background: #45a049;
      }
      
      .add-category-btn:disabled {
        background: #cccccc;
        cursor: not-allowed;
      }

      /* Legend styling */
      #legendContainer {
        max-height: 300px;
        overflow-y: auto;
        margin-top: 10px;
      }
      
      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        padding: 5px;
        border-radius: 4px;
        background: #f9f9f9;
      }
      
      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 3px;
        margin-right: 10px;
        border: 1px solid #ddd;
      }
      
      .legend-label {
        flex: 1;
        font-size: 14px;
      }
      
      .legend-count {
        background: #0079c1;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        margin-left: 10px;
      }

      /* Map container */
      #viewDiv {
        flex: 1;
        height: 100%;
        position: relative;
      }

      /* Styles for collapsed content */
      #sidebar.collapsed {
        height: 60px;
        overflow: hidden;
        padding: 10px 15px;
      }
      #sidebar.collapsed #selectionToolsContent,
      #sidebar.collapsed #colorCustomizationContent,
      #sidebar.collapsed #categoryManagementContent,
      #sidebar.collapsed #legendContent,
      #sidebar.collapsed #layerListContainer {
        max-height: 0;
        opacity: 0;
        margin-bottom: 0;
      }

      /* Logo styling */
      #logo {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 100px;
        height: auto;
        z-index: 100;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      /* Mobile-specific styles */
      @media (max-width: 768px) {
        #main-container {
          flex-direction: column-reverse;
        }
        
        #sidebar {
          width: 100%;
          max-width: 100%;
          height: auto;
          padding: 15px;
          border-radius: 12px 12px 0 0;
          box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
          max-height: 70vh;
        }
        
        #sidebar.collapsed {
          height: 60px;
          padding: 10px 15px;
        }
        
        #sidebar h3 {
          font-size: 18px;
          margin-bottom: 12px;
          padding-bottom: 8px;
        }
        
        .action-button {
          padding: 12px;
          font-size: 16px;
          margin-bottom: 12px;
        }
        
        .color-picker-group label {
          font-size: 16px;
        }
        
        .color-picker-group input[type="color"] {
          width: 50px;
          height: 35px;
        }
        
        #logo {
          width: 80px;
          top: 10px;
          right: 10px;
        }
        
        #collapseToggle {
          padding: 12px;
          font-size: 16px;
        }
      }

      /* Desktop styles */
      @media (min-width: 769px) {
        #main-container {
          flex-direction: row;
        }
        
        #sidebar {
          width: 400px;
          border-radius: 0 8px 8px 0;
          box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
          max-height: none;
        }
        
        #sidebar.collapsed {
          width: 50px;
          height: auto;
        }
      }

      /* Loading indicator */
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #0079c1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div id="main-container">
      <div id="sidebar" class="esri-widget">
        <button id="collapseToggle" aria-expanded="true" aria-label="Zijbalk inklappen">❮ Inklappen</button>

        <div id="selectionToolsContent">
          <h3>Selectiegereedschap</h3>
          <button id="select-button" class="action-button" aria-label="Activeer selectiemodus voor buurten">Selecteer buurten</button>
          <button id="clear-button" class="action-button" aria-label="Wis geselecteerde buurten" disabled>Wis selectie</button>
          <div class="color-picker-group">
            <label for="activeCategorySelect">Actieve categorie:</label>
            <select id="activeCategorySelect" class="category-name">
              <option value="0">Categorie 1</option>
            </select>
          </div>
        </div>

        <div id="categoryManagementContent">
          <h3>Categorieën beheren</h3>
          <div id="categoriesContainer">
            <!-- Categories will be added here dynamically -->
          </div>
          <button id="addCategoryBtn" class="add-category-btn">Categorie toevoegen</button>
        </div>

        <div id="legendContent">
          <h3>Legenda</h3>
          <div id="legendContainer">
            <!-- Legend items will be added here -->
          </div>
        </div>

        <div id="colorCustomizationContent">
          <h3>Kleuren aanpassen</h3>
          <div class="color-picker-group">
            <label for="defaultColorPicker">Standaard buurt kleur:</label>
            <input type="color" id="defaultColorPicker" value="#0078c8" />
          </div>
        </div>

        <div id="layerListContainer" class="widget-content-panel">
          <h3>Kaartlagen</h3>
        </div>
      </div>

      <div id="viewDiv">
        <!-- Map will be rendered here -->
      </div>
    </div>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/layers/TileLayer",
        "esri/layers/GraphicsLayer",
        "esri/Graphic",
        "esri/widgets/LayerList",
        "esri/Basemap",
        "esri/geometry/Extent",
      ], (
        Map,
        MapView,
        FeatureLayer,
        TileLayer,
        GraphicsLayer,
        Graphic,
        LayerList,
        Basemap,
        Extent
      ) => {
        // --- State Variables ---
        let selectedFeatures = []; // Array of {feature, categoryId}
        let categories = [
          { id: 0, name: "Categorie 1", color: "#FF0000", count: 0 }
        ];
        let activeCategoryId = 0;
        let selectHandle = null;
        let hoverGraphicId = null;

        // --- Helper Functions ---
        function debounce(func, wait) {
          let timeout;
          return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
          };
        }

        function hexToRgba(hex, alpha) {
          const r = parseInt(hex.slice(1, 3), 16);
          const g = parseInt(hex.slice(3, 5), 16);
          const b = parseInt(hex.slice(5, 7), 16);
          return `rgba(${r},${g},${b},${alpha})`;
        }

        function updateClearButtonState() {
          const clearButton = document.getElementById("clear-button");
          clearButton.disabled = selectedFeatures.length === 0;
          clearButton.style.opacity = selectedFeatures.length === 0 ? 0.5 : 1;
        }

        function updateHighlights() {
          layers.highlightLayer.removeAll();

          selectedFeatures.forEach((item) => {
            const category = categories.find(c => c.id === item.categoryId);
            if (category) {
              const highlighted = new Graphic({
                geometry: item.feature.geometry,
                attributes: item.feature.attributes,
                symbol: {
                  type: "simple-fill",
                  color: hexToRgba(category.color, 0.5),
                  outline: {
                    color: hexToRgba(category.color, 1),
                    width: 2
                  }
                }
              });
              layers.highlightLayer.add(highlighted);
            }
          });
          
          updateClearButtonState();
          updateLegend();
        }

        function updateLegend() {
          const legendContainer = document.getElementById("legendContainer");
          legendContainer.innerHTML = '';
          
          categories.forEach(category => {
            const item = document.createElement("div");
            item.className = "legend-item";
            
            const colorBox = document.createElement("div");
            colorBox.className = "legend-color";
            colorBox.style.backgroundColor = category.color;
            
            const label = document.createElement("span");
            label.className = "legend-label";
            label.textContent = category.name;
            
            const count = document.createElement("span");
            count.className = "legend-count";
            count.textContent = category.count;
            
            item.appendChild(colorBox);
            item.appendChild(label);
            item.appendChild(count);
            legendContainer.appendChild(item);
          });
        }

        function updateCategoryCounts() {
          // Reset counts
          categories.forEach(category => {
            category.count = 0;
          });
          
          // Count features per category
          selectedFeatures.forEach(item => {
            const category = categories.find(c => c.id === item.categoryId);
            if (category) {
              category.count++;
            }
          });
          
          updateLegend();
          updateCategorySelect();
        }

        function updateCategorySelect() {
          const select = document.getElementById("activeCategorySelect");
          select.innerHTML = '';
          
          categories.forEach(category => {
            const option = document.createElement("option");
            option.value = category.id;
            option.textContent = `${category.name} (${category.count})`;
            option.style.color = category.color;
            select.appendChild(option);
          });
          
          select.value = activeCategoryId;
        }

        function createCategoryElement(category) {
          const container = document.createElement("div");
          container.className = "category-item";
          container.dataset.categoryId = category.id;
          
          const colorBox = document.createElement("input");
          colorBox.type = "color";
          colorBox.className = "category-color";
          colorBox.value = category.color;
          colorBox.title = "Kleur wijzigen";
          
          const nameInput = document.createElement("input");
          nameInput.type = "text";
          nameInput.className = "category-name";
          nameInput.value = category.name;
          nameInput.placeholder = "Categorie naam";
          
          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-category";
          removeBtn.textContent = "X";
          removeBtn.title = "Categorie verwijderen";
          
          colorBox.addEventListener("change", (e) => {
            category.color = e.target.value;
            updateHighlights();
            updateCategorySelect();
          });
          
          nameInput.addEventListener("input", debounce((e) => {
            category.name = e.target.value;
            updateCategorySelect();
            updateLegend();
          }, 300));
          
          removeBtn.addEventListener("click", () => {
            if (categories.length <= 1) {
              alert("Je moet minstens één categorie behouden!");
              return;
            }
            
            // Check if category has features
            const hasFeatures = selectedFeatures.some(item => item.categoryId === category.id);
            if (hasFeatures) {
              if (!confirm("Deze categorie heeft geselecteerde buurten. Wil je deze verwijderen?")) {
                return;
              }
              
              // Remove features from this category
              selectedFeatures = selectedFeatures.filter(item => item.categoryId !== category.id);
            }
            
            // Remove category
            categories = categories.filter(c => c.id !== category.id);
            if (activeCategoryId === category.id) {
              activeCategoryId = categories[0].id;
            }
            
            container.remove();
            updateCategorySelect();
            updateHighlights();
          });
          
          container.appendChild(colorBox);
          container.appendChild(nameInput);
          container.appendChild(removeBtn);
          
          return container;
        }

        function initializeCategories() {
          const container = document.getElementById("categoriesContainer");
          container.innerHTML = '';
          
          categories.forEach(category => {
            const element = createCategoryElement(category);
            container.appendChild(element);
          });
          
          updateCategorySelect();
          updateLegend();
        }

        // --- Initialize Layers with CORRECT URLs ---
        function initializeLayers() {
          // Layer for Den Helder neighborhoods with labels
          const buurtenLayer = new FeatureLayer({
            url: "https://services.arcgis.com/nSZVuSZjHpEZZbRo/arcgis/rest/services/CBS_Buurt_actueel/FeatureServer/0",
            definitionExpression: "Statcode LIKE 'BU0400%'",
            title: "Buurten Den Helder (met labels)",
            outFields: ["*"],
            renderer: {
              type: "simple",
              symbol: {
                type: "simple-fill",
                color: hexToRgba(document.getElementById("defaultColorPicker").value, 0.3),
                outline: {
                  color: hexToRgba(document.getElementById("defaultColorPicker").value, 1),
                  width: 1
                }
              }
            },
            labelingInfo: [{
              labelExpressionInfo: {
                expression: "$feature.Statnaam"
              },
              symbol: {
                type: "text",
                color: "black",
                haloColor: "white",
                haloSize: 1,
                font: {
                  size: 8,
                  weight: "bold"
                }
              }
            }],
            popupEnabled: false,
            featureReduction: null,
            visible: true
          });

          // Layer for Den Helder neighborhoods without labels
          const buurtenNoLabelsLayer = new FeatureLayer({
            url: "https://services.arcgis.com/nSZVuSZjHpEZZbRo/arcgis/rest/services/CBS_Buurt_actueel/FeatureServer/0",
            definitionExpression: "Statcode LIKE 'BU0400%'",
            title: "Buurten Den Helder (geen labels)",
            outFields: ["*"],
            renderer: {
              type: "simple",
              symbol: {
                type: "simple-fill",
                color: hexToRgba(document.getElementById("defaultColorPicker").value, 0.1),
                outline: {
                  color: hexToRgba(document.getElementById("defaultColorPicker").value, 1),
                  width: 1
                }
              }
            },
            labelingInfo: [],
            popupEnabled: false,
            featureReduction: null,
            visible: false
          });

          // FIXED: Use working basemap services
          const basiskaartCanvasLayer = new TileLayer({
            url: "https://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer",
            title: "Basiskaart Canvas",
            visible: true
          });

          // FIXED: Use working topographic service
          const topografieLayer = new TileLayer({
            url: "https://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer",
            title: "Topografische Kaart",
            visible: false
          });

          // FIXED: Use working imagery service
          const luchtfotoLayer = new TileLayer({
            url: "https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",
            title: "Luchtfoto",
            visible: false
          });

          // GraphicsLayer to display selected features
          const highlightLayer = new GraphicsLayer({
            title: "Geselecteerde buurten"
          });

          // GraphicsLayer to display hover effects
          const hoverLayer = new GraphicsLayer({
            title: "Hover Highlight"
          });

          return { 
            buurtenLayer, 
            buurtenNoLabelsLayer, 
            basiskaartCanvasLayer, 
            topografieLayer, 
            luchtfotoLayer, 
            highlightLayer, 
            hoverLayer 
          };
        }

        // --- Initialize Map and View ---
        function initializeMap(layers) {
          // Create the map with working basemap
          const map = new Map({
            basemap: {
              baseLayers: [layers.basiskaartCanvasLayer]
            },
            layers: [
              layers.topografieLayer, 
              layers.luchtfotoLayer, 
              layers.buurtenLayer, 
              layers.buurtenNoLabelsLayer, 
              layers.highlightLayer, 
              layers.hoverLayer
            ]
          });

          // Define the extent for Den Helder
          const denHelderExtent = new Extent({
            xmin: 4.702209510456612,
            ymin: 52.87921251079311,
            xmax: 4.816879514331589,
            ymax: 52.967199689243074,
            spatialReference: { wkid: 4326 }
          });

          // Create the MapView
          const view = new MapView({
            container: "viewDiv",
            map: map,
            extent: denHelderExtent
          });

          return { view };
        }

        // --- Initialize UI Widgets ---
        function initializeWidgets(view) {
          const layerList = new LayerList({
            view: view,
            container: "layerListContainer",
          });
        }

        // --- Initialize Event Listeners ---
        function initializeEvents(view, layers) {
          const selectButton = document.getElementById("select-button");
          const clearButton = document.getElementById("clear-button");
          const defaultColorPicker = document.getElementById("defaultColorPicker");
          const activeCategorySelect = document.getElementById("activeCategorySelect");
          const addCategoryBtn = document.getElementById("addCategoryBtn");
          const sidebar = document.getElementById("sidebar");
          const collapseToggle = document.getElementById("collapseToggle");

          let isCollapsed = false;

          updateClearButtonState();
          initializeCategories();

          // Sidebar collapse/expand
          collapseToggle.addEventListener("click", () => {
            isCollapsed = !isCollapsed;
            if (isCollapsed) {
              sidebar.classList.add("collapsed");
              collapseToggle.textContent = "❯";
              collapseToggle.setAttribute("aria-expanded", "false");
              collapseToggle.setAttribute("aria-label", "Zijbalk uitklappen");
            } else {
              sidebar.classList.remove("collapsed");
              collapseToggle.textContent = "❮ Inklappen";
              collapseToggle.setAttribute("aria-expanded", "true");
              collapseToggle.setAttribute("aria-label", "Zijbalk inklappen");
            }
          });

          // Active category selection
          activeCategorySelect.addEventListener("change", (e) => {
            activeCategoryId = parseInt(e.target.value);
          });

          // Add new category
          addCategoryBtn.addEventListener("click", () => {
            if (categories.length >= 10) {
              alert("Maximum 10 categorieën toegestaan!");
              return;
            }
            
            const newId = Math.max(...categories.map(c => c.id)) + 1;
            const colors = [
              "#FF0000", "#00FF00", "#0000FF", "#FFFF00", "#FF00FF", 
              "#00FFFF", "#FFA500", "#800080", "#008000", "#FFC0CB"
            ];
            
            const newCategory = {
              id: newId,
              name: `Categorie ${newId + 1}`,
              color: colors[categories.length % colors.length],
              count: 0
            };
            
            categories.push(newCategory);
            const element = createCategoryElement(newCategory);
            document.getElementById("categoriesContainer").appendChild(element);
            updateCategorySelect();
            updateLegend();
          });

          // Selection mode
          selectButton.addEventListener("click", () => {
            if (selectHandle) {
              selectHandle.remove();
              selectHandle = null;
              selectButton.textContent = "Selecteer buurten";
              selectButton.classList.remove("active");
              selectButton.style.backgroundColor = "#0079c1";
              return;
            }
            
            selectHandle = view.on("click", (event) => {
              view.hitTest(event).then((response) => {
                const graphic = response.results.find(result =>
                  result.graphic.layer === layers.buurtenLayer || result.graphic.layer === layers.buurtenNoLabelsLayer
                );
                if (graphic) {
                  const objId = graphic.graphic.attributes.OBJECTID;
                  const existingIndex = selectedFeatures.findIndex(item => item.feature.attributes.OBJECTID === objId);
                  
                  if (existingIndex !== -1) {
                    // If already selected, remove it
                    selectedFeatures.splice(existingIndex, 1);
                  } else {
                    // Add new selection with active category
                    selectedFeatures.push({
                      feature: graphic.graphic,
                      categoryId: activeCategoryId
                    });
                  }
                  
                  updateCategoryCounts();
                  updateHighlights();
                }
              }).catch((error) => {
                console.error("Error during hitTest:", error);
              });
            });
            
            selectButton.textContent = "Selectiemodus actief (klik om te stoppen)";
            selectButton.classList.add("active");
            selectButton.style.backgroundColor = "#ff6a00";
          });

          // Clear all selections
          clearButton.addEventListener("click", () => {
            if (selectHandle) {
              selectHandle.remove();
              selectHandle = null;
              selectButton.textContent = "Selecteer buurten";
              selectButton.classList.remove("active");
              selectButton.style.backgroundColor = "#0079c1";
            }
            selectedFeatures = [];
            updateCategoryCounts();
            updateHighlights();
          });

          // Default color picker
          defaultColorPicker.addEventListener("input", debounce((event) => {
            const hex = event.target.value;
            const newColorOutline = hexToRgba(hex, 1);

            layers.buurtenLayer.renderer = {
              type: "simple",
              symbol: {
                type: "simple-fill",
                color: hexToRgba(hex, 0.3),
                outline: { color: newColorOutline, width: 1 }
              }
            };
            
            layers.buurtenNoLabelsLayer.renderer = {
              type: "simple",
              symbol: {
                type: "simple-fill",
                color: hexToRgba(hex, 0.1),
                outline: { color: newColorOutline, width: 1 }
              }
            };
          }, 200));

          // Hover effect
          view.on("pointer-move", (event) => {
            view.hitTest(event).then((response) => {
              const graphic = response.results.find(result =>
                result.graphic.layer === layers.buurtenLayer || result.graphic.layer === layers.buurtenNoLabelsLayer
              );

              if (graphic) {
                const objId = graphic.graphic.attributes.OBJECTID;
                const isSelected = selectedFeatures.some(item => item.feature.attributes.OBJECTID === objId);
                
                if (objId !== hoverGraphicId && !isSelected) {
                  layers.hoverLayer.removeAll();
                  const hoverGraphic = new Graphic({
                    geometry: graphic.graphic.geometry,
                    symbol: {
                      type: "simple-fill",
                      color: hexToRgba("#00FF00", 0.2),
                      outline: {
                        color: hexToRgba("#00FF00", 0.8),
                        width: 1.5
                      }
                    }
                  });
                  layers.hoverLayer.add(hoverGraphic);
                  hoverGraphicId = objId;
                } else if (isSelected) {
                  layers.hoverLayer.removeAll();
                  hoverGraphicId = null;
                }
              } else {
                layers.hoverLayer.removeAll();
                hoverGraphicId = null;
              }
            }).catch((error) => {
              console.error("Error during pointer-move hitTest:", error);
            });
          });
        }

        // --- Main Initialization ---
        const layers = initializeLayers();
        const { view } = initializeMap(layers);

        view.when(() => {
          try {
            initializeWidgets(view);
            initializeEvents(view, layers);
            console.log("Map loaded successfully!");
          } catch (error) {
            console.error("Error initializing widgets or events:", error);
          }
        }).catch((error) => {
          console.error("Error loading map view:", error);
        });
      });
    </script>
  </body>
</html>
